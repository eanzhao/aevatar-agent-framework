# Aevatar Agent Framework - 架构概览

## 🎯 项目愿景

**Aevatar Agent Framework** 是一个多运行时、事件驱动的智能代理框架，基于 .NET 9.0 构建。框架采用分布式Actor模型，提供全面的AI集成能力、事件溯源功能，以及对多种运行时环境的支持。

### 核心理念
> **"语言的震动构建现实"** —— 每个事件是计算宇宙中的一次震动
> *"The vibration of language constructs reality" —— Each event is a vibration in the computational universe*

## 🏗️ 技术栈

| 组件 | 技术 |
|------|------|
| 平台 | .NET 9.0 |
| 语言 | C# 12.0 (启用可空引用类型) |
| 序列化 | Protocol Buffers (Google.Protobuf 3.33.0) |
| Actor框架 | Orleans, ProtoActor, Local (进程内) |
| AI集成 | Microsoft.Extensions.AI, Semantic Kernel |
| 依赖注入 | Microsoft.Extensions.DependencyInjection |
| 可观测性 | OpenTelemetry |
| 配置管理 | Microsoft.Extensions.Configuration |

## 🏛️ 架构模式

### 分层架构

```
┌─────────────────────────────────────────────────────────┐
│                  应用层 (Applications)                   │
│              Demo.Api / Examples / AI Agents           │
├─────────────────────────────────────────────────────────┤
│              运行时抽象层 (IGAgentActor)                  │
│         统一的 Actor 接口，隔离具体运行时实现             │
├──────────────┬──────────────────┬───────────────────────┤
│    Local     │   ProtoActor     │      Orleans          │
│   Runtime    │    Runtime       │     Runtime           │
│   (进程内)    │   (Actor模型)     │    (虚拟Actor)        │
├──────────────┴──────────────────┴───────────────────────┤
│               业务逻辑层 (IGAgent)                        │
│           Agent 业务逻辑定义与事件处理                      │
├─────────────────────────────────────────────────────────┤
│                  核心基类 (GAgentBase)                    │
│                事件处理、生命周期、状态管理                  │
├─────────────────────────────────────────────────────────┤
│                 EventSourcing 层                        │
│             事件存储、重放、快照 (可选)                     │
├─────────────────────────────────────────────────────────┤
│              消息序列化层 (Protobuf)                      │
│              统一的消息格式与高效序列化                     │
└─────────────────────────────────────────────────────────┘
```

### 事件驱动架构

- **事件信封模式**: 所有事件都包装在标准化信封中
- **事件传播**: 层次化路由 (上/下/双向传播)
- **事件去重**: 基于内存缓存的重复检测
- **事件溯源**: 可选的持久化事件存储和重放

## 🔧 核心组件

### 1. 代理抽象层 (`Aevatar.Agents.Abstractions`)

#### 关键接口
- **`IGAgent`**: 基础代理接口，包含唯一标识
- **`IStateGAgent<TState>`**: 有状态代理，支持泛型状态管理
- **`IGAgentActor`**: 运行时Actor抽象，管理生命周期
- **`IEventPublisher`**: 事件发布接口，支持方向控制
- **`IMessageStream`**: 基于流的消息通信

#### 事件系统
- **`EventEnvelope`**: 标准化事件包装器，包含传播元数据
- **`EventDirection`**: 上/下/双向传播控制
- **事件属性**: `[EventHandler]`, `[AllEventHandler]` 用于方法发现

### 2. 核心实现 (`Aevatar.Agents.Core`)

#### 基础类
- **`GAgentBase<TState>`**: 所有代理的基础
  - 通过反射自动发现事件处理器
  - 内置可观测性和指标收集
  - 异常处理和事件发布
  - 资源上下文管理

- **`GAgentActorBase`**: 运行时抽象基础
  - 事件路由和传播逻辑
  - 层次化关系管理
  - 事件去重机制
  - 生命周期管理 (激活/停用)

### 3. AI集成层 (`Aevatar.Agents.AI.*`)

#### 架构层级
```
┌─────────────────────────────────────────────┐
│          Application Layer                   │
│         (Your AI Agents)                     │
├─────────────────────────────────────────────┤
│      AevatarAIAgentBase<TState>             │
│    (AI-Enhanced Agent Base Class)           │
├─────────────────────────────────────────────┤
│         AI Abstraction Layer                 │
│  ┌──────────────────┬────────────────────┐ │
│  │IAevatarLLMProvider│IAevatarToolManager │ │
│  │                   │                    │ │
│  │IAevatarPromptMgr  │IAevatarMemory     │ │
│  └──────────────────┴────────────────────┘ │
├─────────────────────────────────────────────┤
│         LLM Implementation Layer             │
│  ┌─────────────┬────────────────────────┐  │
│  │  Semantic   │  Microsoft AutoGen      │  │
│  │   Kernel    │  (MAF)                  │  │
│  └─────────────┴────────────────────────┘  │
├─────────────────────────────────────────────┤
│        Core Agent Framework                  │
│         (GAgentBase + Events)                │
└─────────────────────────────────────────────┘
```

#### AI代理特性
- **`AIGAgentBase<TState>`**: AI增强代理基础类
- **多LLM支持**: 可插拔LLM提供程序 (OpenAI, Azure, Local)
- **工具系统**: 可扩展工具框架，支持函数调用
- **处理策略**: 思维链、ReAct、思维树
- **内存管理**: 对话历史和工作记忆
- **流式支持**: 实时响应流式传输

### 4. 运行时实现

#### Local Runtime (`Aevatar.Agents.Local`)
- **进程内执行**: 直接方法调用
- **基于通道的消息传递**: System.Threading.Channels
- **轻量级**: 简单场景的最小开销

#### Orleans Runtime (`Aevatar.Agents.Orleans`)
- **虚拟Actor**: 分布式Actor系统
- **基于Grain**: Orleans grains作为Actor实现
- **集群**: 支持多节点部署
- **持久化**: 可选的状态持久化

#### ProtoActor Runtime (`Aevatar.Agents.ProtoActor`)
- **高性能**: 优化的吞吐量
- **轻量级**: 最小内存占用
- **基于邮箱**: 异步消息处理

## 🔄 数据流和通信模式

### 事件流
```
用户请求 → 代理业务逻辑 → 事件发布 → 事件路由器 →
层次化传播 → 子代理处理 → 响应聚合
```

### AI处理流
```
输入 → AI上下文创建 → LLM提供程序 → 工具执行(如需要) →
响应生成 → 事件转换 → 层次化传播
```

### 工具执行流
```
工具请求 → 参数验证 → 工具上下文创建 →
工具执行 → 结果处理 → 响应生成
```

## 🔐 安全与防护

### 工具安全
- **参数验证**: 类型检查和约束验证
- **速率限制**: 内置工具执行速率限制
- **确认要求**: 危险操作需要确认
- **访问控制**: 敏感操作的内部访问标志

### 事件安全
- **事件验证**: 事件负载的模式验证
- **传播控制**: 可配置的传播限制
- **去重**: 防止重放攻击

## 📊 可观测性和监控

### 内置指标
- **事件指标**: 发布、处理、丢弃的事件
- **性能指标**: 延迟、吞吐量、错误率
- **AI指标**: Token使用、响应时间、工具执行
- **运行时指标**: Actor激活、内存使用

### 日志集成
- **结构化日志**: Microsoft.Extensions.Logging集成
- **日志范围**: 带有代理ID和事件关联的上下文日志
- **可配置级别**: 调试、信息、警告、错误

### 分布式跟踪
- **OpenTelemetry**: 完整的跟踪支持
- **事件关联**: 自动关联ID传播
- **自定义跨度**: AI处理、工具执行跟踪

## 🚀 核心优势

1. **多运行时灵活性**: 在Local、ProtoActor和Orleans之间无缝切换
2. **AI原生设计**: 与多种LLM的一流集成
3. **事件驱动架构**: 具有层次化传播的健壮事件系统
4. **可扩展工具系统**: 强大且安全的工具执行框架
5. **生产就绪**: 全面的可观测性、错误处理和监控
6. **类型安全**: 泛型和编译时验证的强类型
7. **性能优化**: 高效的事件路由、缓存和去重

## 📈 扩展点

框架提供多个扩展点用于定制：
- **自定义运行时实现**: 新的Actor运行时支持
- **AI提供程序扩展**: 新的LLM框架集成
- **工具生态系统**: 领域特定工具库
- **内存系统**: 自定义内存和检索系统
- **处理策略**: 新的AI推理模式
- **事件存储**: 自定义事件持久化解决方案

---

*本文档作为框架架构的概览，为后续详细的组件设计和实现优化提供指导。*